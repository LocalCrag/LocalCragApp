name: Check Migrate from prod DB
run-name: Check Migrate from prod DB ðŸ§ª

on:
  pull_request_target:
    branches:
      - main
      - next

jobs:
  check-migrate-from-prod-db:
    environment: ${{ github.actor == 'dorthrithil' && 'Testing-dorthrithil' || 'Testing' }}
    runs-on: ubuntu-latest
    services:
      test_db:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: localcrag_test
        ports:
          - 5432:5432
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:

      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.14

      - name: Install pipenv
        run: pip install pipenv

      - name: Installing pipenv dependencies
        run: |
          cd server/src
          pipenv install --deploy --ignore-pipfile

      - name: Install MinIO Client (mc)
        run: |
          wget https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          sudo mv mc /usr/local/bin/

      - name: Pull newest prod dump from S3
        env:
          S3_ACCESS_KEY: ${{ secrets.BACKUP_S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.BACKUP_S3_SECRET_KEY }}
          S3_ENDPOINT: ${{ secrets.BACKUP_S3_ENDPOINT }}
          S3_BUCKET: ${{ secrets.BACKUP_S3_BUCKET }}
          S3_PREFIX: ${{ secrets.BACKUP_S3_PREFIX }}
        run: |
          set -euo pipefail
          
          mkdir -p server/tests/dumps
          
          echo "Configuring mc alias..."
          mc alias set s3backup "${S3_ENDPOINT}" "${S3_ACCESS_KEY}" "${S3_SECRET_KEY}" > /dev/null 2>&1
          
          echo "Looking for latest backup..."
          
          # List all snapshot directories and sort to get the newest one
          NEWEST_BACKUP=$(mc ls "s3backup/${S3_BUCKET}/${S3_PREFIX}/" 2>/dev/null | awk '{print $NF}' | grep '/$' | sed 's:/$::' | sort -r | head -n 1)
          
          if [ -z "$NEWEST_BACKUP" ]; then
            echo "Error: No backups found"
            exit 1
          fi
          
          echo "Found backup: $NEWEST_BACKUP"
          
          # Download the postgres dump from the newest backup (hardcoded to localcrag)
          echo "Downloading backup..."
          mc cp "s3backup/${S3_BUCKET}/${S3_PREFIX}/${NEWEST_BACKUP}/postgres/localcrag.sql.gz" server/tests/dumps/localcrag_prod_dump.sql.gz > /dev/null 2>&1
          
          echo "Decompressing backup..."
          gunzip server/tests/dumps/localcrag_prod_dump.sql.gz
          echo "Backup ready for restore."

      - name: Setup database with prod dump
        run: |
          echo "Creating UUID extension..."
          export PGPASSWORD='postgres'; psql -h 0.0.0.0 -p 5432 -U postgres -d localcrag_test < server/scripts/create_uuid_extension.sql > /dev/null 2>&1
          echo "Restoring database from backup..."
          export PGPASSWORD='postgres'; psql -h 0.0.0.0 -p 5432 -U postgres -d localcrag_test < server/tests/dumps/localcrag_prod_dump.sql > /dev/null 2>&1
          echo "Database restored successfully."

      - name: Run Migrations
        run: |
          cd server/src
          export PYTHONPATH=.
          export LOCALCRAG_CONFIG=config/test-ci.cfg
          pipenv run flask db upgrade

